
namespace eval ::astronomica::nutation {
    namespace path [namespace parent]

    ########################
    # Chapter 22
    # Nutation and Obliquity
    ########################

    variable coefficients {
	 0.0  0.0  0.0  0.0  1.0 -171996.0 -174.2 92025.0  8.9
	-2.0  0.0  0.0  2.0  2.0  -13187.0   -1.6  5736.0 -3.1
	 0.0  0.0  0.0  2.0  2.0   -2274.0   -0.2   977.0 -0.5
	 0.0  0.0  0.0  0.0  2.0    2062.0    0.2  -895.0  0.5
	 0.0  1.0  0.0  0.0  0.0    1426.0   -3.4    54.0 -0.1
	 0.0  0.0  1.0  0.0  0.0     712.0    0.1    -7.0  0.0
	-2.0  1.0  0.0  2.0  2.0    -517.0    1.2   224.0 -0.6
	 0.0  0.0  0.0  2.0  1.0    -386.0   -0.4   200.0  0.0
	 0.0  0.0  1.0  2.0  2.0    -301.0    0.0   129.0 -0.1
	-2.0 -1.0  0.0  2.0  2.0     217.0   -0.5   -95.0  0.3
	-2.0  0.0  1.0  0.0  0.0    -158.0    0.0     0.0  0.0
	-2.0  0.0  0.0  2.0  1.0     129.0    0.1   -70.0  0.0
	 0.0  0.0 -1.0  2.0  2.0     123.0    0.0   -53.0  0.0
	 2.0  0.0  0.0  0.0  0.0      63.0    0.0     0.0  0.0
	 0.0  0.0  1.0  0.0  1.0      63.0    0.1   -33.0  0.0
	 2.0  0.0 -1.0  2.0  2.0     -59.0    0.0    26.0  0.0
	 0.0  0.0 -1.0  0.0  1.0     -58.0   -0.1    32.0  0.0
	 0.0  0.0  1.0  2.0  1.0     -51.0    0.0    27.0  0.0
	-2.0  0.0  2.0  0.0  0.0      48.0    0.0     0.0  0.0
	 0.0  0.0 -2.0  2.0  1.0      46.0    0.0   -24.0  0.0
	 2.0  0.0  0.0  2.0  2.0     -38.0    0.0    16.0  0.0
	 0.0  0.0  2.0  2.0  2.0     -31.0    0.0    13.0  0.0
	 0.0  0.0  2.0  0.0  0.0      29.0    0.0     0.0  0.0
	-2.0  0.0  1.0  2.0  2.0      29.0    0.0   -12.0  0.0
	 0.0  0.0  0.0  2.0  0.0      26.0    0.0     0.0  0.0
	-2.0  0.0  0.0  2.0  0.0     -22.0    0.0     0.0  0.0
	 0.0  0.0 -1.0  2.0  1.0      21.0    0.0   -10.0  0.0
	 0.0  2.0  0.0  0.0  0.0      17.0   -0.1     0.0  0.0
	 2.0  0.0 -1.0  0.0  1.0      16.0    0.0    -8.0  0.0
	-2.0  2.0  0.0  2.0  2.0     -16.0    0.1     7.0  0.0
	 0.0  1.0  0.0  0.0  1.0     -15.0    0.0     9.0  0.0
	-2.0  0.0  1.0  0.0  1.0     -13.0    0.0     7.0  0.0
	 0.0 -1.0  0.0  0.0  1.0     -12.0    0.0     6.0  0.0
	 0.0  0.0  2.0 -2.0  0.0      11.0    0.0     0.0  0.0
	 2.0  0.0 -1.0  2.0  1.0     -10.0    0.0     5.0  0.0
	 2.0  0.0  1.0  2.0  2.0      -8.0    0.0     3.0  0.0
	 0.0  1.0  0.0  2.0  2.0       7.0    0.0    -3.0  0.0
	-2.0  1.0  1.0  0.0  0.0      -7.0    0.0     0.0  0.0
	 0.0 -1.0  0.0  2.0  2.0      -7.0    0.0     3.0  0.0
	 2.0  0.0  0.0  2.0  1.0      -7.0    0.0     3.0  0.0
	 2.0  0.0  1.0  0.0  0.0       6.0    0.0     0.0  0.0
	-2.0  0.0  2.0  2.0  2.0       6.0    0.0    -3.0  0.0
	-2.0  0.0  1.0  2.0  1.0       6.0    0.0    -3.0  0.0
	 2.0  0.0 -2.0  0.0  1.0      -6.0    0.0     3.0  0.0
	 2.0  0.0  0.0  0.0  1.0      -6.0    0.0     3.0  0.0
	 0.0 -1.0  1.0  0.0  0.0       5.0    0.0     0.0  0.0
	-2.0 -1.0  0.0  2.0  1.0      -5.0    0.0     3.0  0.0
	-2.0  0.0  0.0  0.0  1.0      -5.0    0.0     3.0  0.0
	 0.0  0.0  2.0  2.0  1.0      -5.0    0.0     3.0  0.0
	-2.0  0.0  2.0  0.0  1.0       4.0    0.0     0.0  0.0
	-2.0  1.0  0.0  2.0  1.0       4.0    0.0     0.0  0.0
	 0.0  0.0  1.0 -2.0  0.0       4.0    0.0     0.0  0.0
	-1.0  0.0  1.0  0.0  0.0      -4.0    0.0     0.0  0.0
	-2.0  1.0  0.0  0.0  0.0      -4.0    0.0     0.0  0.0
	 1.0  0.0  0.0  0.0  0.0      -4.0    0.0     0.0  0.0
	 0.0  0.0  1.0  2.0  0.0       3.0    0.0     0.0  0.0
	 0.0  0.0 -2.0  2.0  2.0      -3.0    0.0     0.0  0.0
	-1.0 -1.0  1.0  0.0  0.0      -3.0    0.0     0.0  0.0
	 0.0  1.0  1.0  0.0  0.0      -3.0    0.0     0.0  0.0
	 0.0 -1.0  1.0  2.0  2.0      -3.0    0.0     0.0  0.0
	 2.0 -1.0 -1.0  2.0  2.0      -3.0    0.0     0.0  0.0
	 0.0  0.0  3.0  2.0  2.0      -3.0    0.0     0.0  0.0
	 2.0 -1.0  0.0  2.0  2.0      -3.0    0.0     0.0  0.0
    }

    proc nutationInLongitude {jd} {
	variable coefficients

	set t [expr {($jd - 2451545) / 36525.0}]

	set d [expr {297.85036 + 445267.111480*$t - 0.0019142*$t**2 + $t**3/189474.0}]
	set d [math::normalize360 $d]

	set m [expr {357.52772 + 35999.050340*$t - 0.0001603*$t**2 - $t**3/300000.0}]
	set m [math::normalize360 $m]

	set mp [expr {134.96298 + 477198.867398*$t + 0.0086972*$t**2 + $t**3/56250.0}]
	set mp [math::normalize360 $mp]

	set f [expr {93.27191 + 483202.017538*$t - 0.0036825*$t**2 + $t**3/327270.0}]
	set f [math::normalize360 $f]

	set o [expr {125.04452 - 1934.136261*$t + 0.0020708*$t**2 + $t**3/450000.0}]
	set o [math::normalize360 $o]

	set nutation 0
	foreach {dcoeff mcoeff mpcoeff fcoeff ocoeff sincoeff1 sincoeff2 coscoeff1 coscoeff2} $coefficients {
	    set arg [expr {$dcoeff*$d + $mcoeff*$m + $mpcoeff*$mp + $fcoeff*$f + $ocoeff*$o}]
	    set nutation [expr {$nutation + ($sincoeff1 + $sincoeff2*$t) * sin([math::toRadians $arg]) * 0.0001}]
	}

	return $nutation ;# in arc seconds
    }

    proc nutationInObliquity {jd} {
	variable coefficients

	set t [expr {($jd - 2451545) / 36525.0}]

	set d [expr {297.85036 + 445267.111480*$t - 0.0019142*$t**2 + $t**3/189474.0}]
	set d [math::normalize360 $d]

	set m [expr {357.52772 + 35999.050340*$t - 0.0001603*$t**2 - $t**3/300000.0}]
	set m [math::normalize360 $m]

	set mp [expr {134.96298 + 477198.867398*$t + 0.0086972*$t**2 + $t**3/56250.0}]
	set mp [math::normalize360 $mp]

	set f [expr {93.27191 + 483202.017538*$t - 0.0036825*$t**2 + $t**3/327270.0}]
	set f [math::normalize360 $f]

	set o [expr {125.04452 - 1934.136261*$t + 0.0020708*$t**2 + $t**3/450000.0}]
	set o [math::normalize360 $o]

	set nutation 0
	foreach {dcoeff mcoeff mpcoeff fcoeff ocoeff sincoeff1 sincoeff2 coscoeff1 coscoeff2} $coefficients {
	    set arg [expr {$dcoeff*$d + $mcoeff*$m + $mpcoeff*$mp + $fcoeff*$f + $ocoeff*$o}]
	    set nutation [expr {$nutation + ($coscoeff1 + $coscoeff2*$t) * cos([math::toRadians $arg]) * 0.0001}]
	}

	return $nutation ;# in arc seconds
    }

    # Formula 22.3
    proc meanObliquityOfEcliptic {jd} {
	set u [expr {($jd - 2451545) / 3652500.0}]
	set seconds [expr {21.448 - 4680.93*$u
				    - 1.55*$u**2
				    + 1999.25*$u**3
				    - 51.38*$u**4
				    - 249.67*$u**5
				    - 39.05*$u**6
				    + 7.12*$u**7
				    + 27.87*$u**8
				    + 5.79*$u**9
				    + 2.45*$u**10}]

	set obliquity [expr {23 + (26 / 60.0) + ($seconds / 3600.0)}]
	return $obliquity ;# in degrees
    }

    proc trueObliquityOfEcliptic {jd} {
	set obliquity [meanObliquityOfEcliptic $jd]
	set nutation [nutationInObliquity $jd]

	return [expr {$obliquity + $nutation / 3600.0}] ;# in degrees
    }
}
